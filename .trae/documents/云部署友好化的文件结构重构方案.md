## 目标
- 面向云服务器的部署、开发、维护简化为“少数固定命令”，降低人为操作成本
- 明确层次与职责，隔离运行时配置、脚本工具、源代码与测试
- 强化环境与日志管理，避免敏感信息泄露，确保可观察性与可回滚

## 现状诊断
- 配置分散：`.env` 直接放敏感值，`src/config/config.js`读取环境变量但无环境分层
- 日志与运行方式不统一：容器/系统进程日志策略未明确
- 测试结构庞杂：`tests/manual`、`tests/integration`、`tests/utils`交织，命令多且不直观
- 部署脚本缺失：缺少可重复的一键部署流程

## 建议目录结构
```
project/
├── src/                       # 业务源码
│   ├── app/                   # 应用入口与初始化（如 index.js）
│   ├── bot/                   # Discord 相关（client、commands）
│   ├── audio/                 # 音频抽取、播放、管理
│   ├── control/               # 播放控制层（PlayerControl 等）
│   ├── ui/                    # 嵌入消息、按钮、进度条
│   ├── services/              # 通用服务（logger、metrics、cache）
│   ├── utils/                 # 工具方法（debug、验证等）
│   └── config/                # 运行时配置模块（读取 env，提供统一配置对象）
├── tests/                     # 测试总目录
│   ├── unit/                  # 单元测试（Jest）
│   ├── integration/           # 组件/模块集成测试
│   └── e2e/                   # 端到端/系统级测试（可选）
├── scripts/                   # 自动化脚本
│   ├── deploy/                # 部署相关脚本
│   │   ├── build.sh           # 构建镜像/产物
│   │   ├── release.sh         # 滚动更新/回滚
│   │   └── healthcheck.sh     # 健康检查
│   ├── maintenance/           # 维护脚本（日志收集、诊断）
│   └── tools/                 # 开发工具（命令注册、数据清理）
├── config/                    # 非运行时的工程配置（Docker、PM2、ESLint 等）
│   ├── docker/                # Dockerfile、compose 文件
│   ├── pm2/                   # ecosystem.config.js（可选）
│   └── ci/                    # CI/CD 配置（如 GitHub Actions）
├── docs/                      # 文档（仅需要时）
├── .env.example               # 环境变量模板（无敏感信息）
├── .gitignore                 # 标准忽略规则
└── package.json               # npm 脚本作为统一入口
```

## 配置与环境管理
- 使用 `.env.example` 作为模板，不提交真实 `.env`
- 环境分层：`NODE_ENV=development|staging|production`
- 统一由 `src/config/config.js` 读取 env：
  - `logging.level` 来自 `LOG_LEVEL`（可选：error|warn|info|debug|verbose|silly）
  - `discord.token/clientId` 从 env 注入
  - `audio.*` 时限与阈值统一从 env 注入，提供默认值
- 生产环境优先 stdout 日志（容器化友好）；本地可追加文件日志

## 部署方案（二选一，均可保留）
- 方案 A：Docker（推荐）
  - `config/docker/Dockerfile` 最小化镜像；非 root 运行
  - `config/docker/compose.dev.yml` 本地开发一键起：`docker compose up`
  - 云部署：`scripts/deploy/release.sh` 执行 `docker build` + `docker run`（标签带版本/commit）
  - 日志：走 stdout，由平台采集（如 CloudWatch/ELK）
- 方案 B：系统进程（PM2 或 systemd）
  - `config/pm2/ecosystem.config.js`：环境变量注入、日志轮转
  - 云部署：`scripts/deploy/release.sh` 拉取代码 + `pm2 restart` 或 `systemctl restart`
  - 日志：journald 或 PM2 日志，统一采集

## 运行与维护流程
- 开发：
  - `npm run dev`（本地）或 `docker compose up`（容器）
  - 统一测试入口：`npm run test`、`npm run test:coverage`
- 部署：
  - `npm run deploy` → 调用 `scripts/deploy/release.sh`（构建、替换、健康检查、回滚策略）
- 监控/诊断：
  - 健康检查脚本：检验 Discord 连通性、音频管线、命令响应
  - 日志级别通过 `LOG_LEVEL` 动态调整；提供 `scripts/maintenance/*` 快速抓取诊断信息

## 渐进式迁移计划
1. 新增 `.env.example`，清理 `.env` 敏感内容，保留注释与占位
2. 在 `src/config/config.js` 内完成“所有配置从 env 统一读取”的收口（已具备基础能力，完善默认值与分层）
3. 归档测试：将 `tests/manual/*` 归入 `tests/integration/` 或 `tests/e2e/` 并合并 npm 脚本入口
4. 引入 `config/docker/Dockerfile` 与 `compose.dev.yml`，本地验证镜像与运行
5. 增加 `scripts/deploy/release.sh` 与 `scripts/deploy/healthcheck.sh`，定义一键发布与健康检查
6. 统一日志策略：生产仅 stdout；开发允许文件日志，`.gitignore` 忽略 `logs/`
7. 更新 `package.json`：
   - `dev`、`start`、`test`、`lint`、`deploy` 等脚本标准化
8. 文档最小化更新：在 `docs/` 增补《部署与维护指南》（可选，按需）

## 风险与注意事项
- 不提交真实 `.env`；云端通过平台 Secrets 或注入环境变量
- Docker 构建需注意 `node_modules` 缓存与镜像层大小
- 统一导入路径后需批量更新相对路径（一次性脚本处理）
- 健康检查需考虑 Discord API 限速与无状态重启

---
请确认上述重构方案与部署策略（Docker 或系统进程）偏好；确认后我将按“渐进式迁移计划”逐步实施，并在每一步完成后验证与汇报。